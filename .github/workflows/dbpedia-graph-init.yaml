name: Collect IRIs from dataset 'DBpedia'

on:
  push:
    branches: ["main"]

jobs:

  graph-init:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: npx turbo run build --filter=@colonial-collections/graph-init
      - name: Collect and queue IRIs from a SPARQL endpoint
        run: |
          ./apps/graph-init/dist/cli.js run \
            --endpoint-url "https://dbpedia.org/sparql" \
            --query-file ./apps/graph-init/fixtures/iterate-1.rq \
            --number-of-iris-per-request 10 \
            --wait-between-requests 500 \
            --resource-dir ./resources \
            --queue-file ./queue.sqlite

  graph-dereference:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm ci
      - run: npx turbo run build --filter=@colonial-collections/graph-dereference
      - name: Create or update a graph by dereferencing IRIs
        run: |
          ./apps/graph-dereference/dist/cli.js dereference \
            --resource-dir ./resources \
            --queue-file ./queue.sqlite \
            --number-of-concurrent-requests 1 \
            --wait-between-requests 100 \
            --batch-size 10
